<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Totaal Bedrag - Rekeningen</title>
  <style>
    :root {
      --bg:#0b0f19;--card:#121826;--ink:#e7ecf3;--muted:#9aa8b4;--accent:#5b9dff;--err:#f04438;
    }
    body {
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial;
      background:linear-gradient(180deg,#0b0f19,#0e1424 30%,#0b0f19);
      color:var(--ink);min-height:100vh;padding:20px;
    }
    .card {background:var(--card);border-radius:16px;padding:20px;max-width:600px;margin:40px auto;box-shadow:0 8px 25px rgba(0,0,0,.3);}
    .hidden{display:none!important;}
    h1{margin-top:0;}
    input,select,button{border-radius:8px;padding:10px;font-size:16px;margin:4px 0;}
    input,select{width:100%;border:1px solid #444;background:#0b1020;color:var(--ink);}
    button{cursor:pointer;}
    .primary{background:var(--accent);color:#000;border:0;}
    .ghost{background:transparent;border:1px solid #444;color:var(--ink);}
    .danger{background:transparent;border:1px solid var(--err);color:var(--err);}
    #userInfo{position:absolute;top:10px;right:15px;}
    .list-row{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #222;padding:6px 0;}
  </style>
</head>
<body>
  <div id="userInfo" class="hidden">
    <span id="who"></span>
    <button id="signOut" class="ghost">Uitloggen</button>
  </div>

  <div class="card">
    <h1 id="title">Login om rekeningen te zien</h1>

    <div id="loginSection">
      <button id="signIn" class="primary">Inloggen met Google</button>
    </div>

    <div id="noAccess" class="hidden">
      <p>Je hebt (nog) geen rekening. Neem contact op met de beheerder.</p>
    </div>

    <div id="balanceSection" class="hidden">
      <h2>Jouw totaal</h2>
      <p id="balance">â‚¬0,00</p>
      <div id="editorControls" class="hidden">
        <input id="amount" type="text" placeholder="Bedrag (bijv. 12,34)">
        <button id="add" class="primary">Toevoegen</button>
        <button id="reset" class="danger">Resetten</button>
      </div>
    </div>

    <div id="adminPanel" class="hidden">
      <h2>Beheer gebruikers</h2>
      <div>
        <input id="newEmail" type="text" placeholder="E-mail of UID">
        <select id="newRole">
          <option value="viewer">Viewer</option>
          <option value="editor">Editor</option>
        </select>
        <button id="addUser" class="primary">Toevoegen</button>
      </div>
      <div id="userList"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, getDocs, onSnapshot, runTransaction } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    // ðŸ”¥ Jouw Firebase-config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT",
      appId: "YOUR_APP_ID"
    };
    const ADMIN_UID = "YOUR_ADMIN_UID";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const el = id => document.getElementById(id);

    // UI elementen
    const signInBtn = el("signIn");
    const signOutBtn = el("signOut");
    const who = el("who");
    const userInfo = el("userInfo");
    const loginSection = el("loginSection");
    const balanceSection = el("balanceSection");
    const adminPanel = el("adminPanel");
    const editorControls = el("editorControls");
    const noAccess = el("noAccess");
    const balance = el("balance");
    const userList = el("userList");

    let currentUser = null;
    let currentRole = null;

    // ðŸ”¹ Login/out
    signInBtn.onclick = async () => {
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
    };
    signOutBtn.onclick = () => signOut(auth);

    // ðŸ”¹ Na inloggen
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        loginSection.classList.remove("hidden");
        userInfo.classList.add("hidden");
        adminPanel.classList.add("hidden");
        balanceSection.classList.add("hidden");
        noAccess.classList.add("hidden");
        return;
      }
      currentUser = user;
      who.textContent = user.email;
      userInfo.classList.remove("hidden");
      loginSection.classList.add("hidden");

      if (user.uid === ADMIN_UID) {
        showAdminPanel();
      }

      // Check of gebruiker bestaat in allowedUsers
      const allowedRef = doc(db, "allowedUsers", user.uid);
      const allowedSnap = await getDoc(allowedRef);
      if (!allowedSnap.exists() && user.uid !== ADMIN_UID) {
        noAccess.classList.remove("hidden");
        balanceSection.classList.add("hidden");
        return;
      }
      currentRole = user.uid === ADMIN_UID ? "admin" : allowedSnap.data().role;
      noAccess.classList.add("hidden");
      balanceSection.classList.remove("hidden");
      loadUserBalance(user.uid);
    });

    async function loadUserBalance(uid) {
      const ref = doc(db, "totals", uid);
      onSnapshot(ref, snap => {
        const val = snap.exists() ? (snap.data().cents || 0) : 0;
        balance.textContent = (val/100).toLocaleString("nl-NL",{style:"currency",currency:"EUR"});
      });
      if (currentRole === "editor" || currentRole === "admin") {
        editorControls.classList.remove("hidden");
      } else {
        editorControls.classList.add("hidden");
      }
    }

    el("add").onclick = async () => {
      const amount = parseFloat(el("amount").value.replace(",", "."));
      if (isNaN(amount)) return alert("Ongeldig bedrag");
      const cents = Math.round(amount * 100);
      const ref = doc(db, "totals", currentUser.uid);
      await runTransaction(db, async (tx) => {
        const snap = await tx.get(ref);
        const current = snap.exists() ? snap.data().cents || 0 : 0;
        tx.set(ref, { cents: current + cents });
      });
      el("amount").value = "";
    };

    el("reset").onclick = async () => {
      const ref = doc(db, "totals", currentUser.uid);
      await setDoc(ref, { cents: 0 });
    };

    // ðŸ”¹ Admin functies
    async function showAdminPanel() {
      adminPanel.classList.remove("hidden");
      loadUsers();

      el("addUser").onclick = async () => {
        const email = el("newEmail").value.trim();
        const role = el("newRole").value;
        if (!email) return alert("Voer e-mail of UID in");
        const newUid = email; // gebruik UID of e-mail als ID
        await setDoc(doc(db, "allowedUsers", newUid), { email, role });
        el("newEmail").value = "";
        loadUsers();
      };
    }

    async function loadUsers() {
      userList.innerHTML = "";
      const querySnap = await getDocs(collection(db, "allowedUsers"));
      querySnap.forEach(docu => {
        const data = docu.data();
        const row = document.createElement("div");
        row.className = "list-row";
        row.innerHTML = `
          <div>${data.email} (${data.role})</div>
          <div>
            <button data-uid="${docu.id}" data-role="${data.role}" class="ghost toggleRole">Wijzig rol</button>
            <button data-uid="${docu.id}" class="danger deleteUser">Verwijder</button>
          </div>
        `;
        userList.appendChild(row);
      });

      // Eventlisteners
      document.querySelectorAll(".toggleRole").forEach(btn=>{
        btn.onclick = async ()=>{
          const uid = btn.dataset.uid;
          const current = btn.dataset.role;
          const newRole = current==="viewer"?"editor":"viewer";
          await updateDoc(doc(db,"allowedUsers",uid),{role:newRole});
          loadUsers();
        };
      });
      document.querySelectorAll(".deleteUser").forEach(btn=>{
        btn.onclick = async ()=>{
          await deleteDoc(doc(db,"allowedUsers",btn.dataset.uid));
          loadUsers();
        };
      });
    }
  </script>
</body>
</html>
